<!doctype html><html lang=fr dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#FFFFFF"><title>Terragrunt et découverte de l'IAC en mode DRY &#183; </title><meta name=title content="Terragrunt et découverte de l'IAC en mode DRY &#183; "><script type=text/javascript src=/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.8f25b3b1fdd42cfaf2092d7e98b41f6474cfaf471f6aeb265f7ba2579197e54e.css integrity="sha256-jyWzsf3ULPryCS1+mLQfZHTPr0cfausmX3uiV5GX5U4="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.81b6b27b20d7cc222185cf48bd73cd7dac1fa12efea633d2e2c7b1930d36259f.js integrity="sha256-gbayeyDXzCIhhc9IvXPNfawfoS7+pjPS4sexkw02JZ8=" data-copy=Copier data-copied=Copié></script><meta name=description content="
      Découverte de Terragrunt et de l'IAC en mode DRY
    "><link rel=canonical href=https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/"><meta property="og:site_name" content="fchevalier.net"><meta property="og:title" content="Terragrunt et découverte de l'IAC en mode DRY"><meta property="og:description" content="Découverte de Terragrunt et de l'IAC en mode DRY"><meta property="og:locale" content="fr"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-04-16T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-16T00:00:00+00:00"><meta property="article:tag" content="Cloud"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="Iac"><meta property="article:tag" content="Terragrunt"><meta property="article:tag" content="Dry"><meta property="og:image" content="https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/cover.png"><meta name=twitter:title content="Terragrunt et découverte de l'IAC en mode DRY"><meta name=twitter:description content="Découverte de Terragrunt et de l'IAC en mode DRY"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"Terragrunt et découverte de l\u0027IAC en mode DRY","headline":"Terragrunt et découverte de l\u0027IAC en mode DRY","description":"Découverte de Terragrunt et de l\u0027IAC en mode DRY","abstract":"Découverte du wrapper Terragrunt, permettant de gérer des configurations Terraform en adoptant une approche DRY (Don\u0026rsquo;t Repeat Yourself).","inLanguage":"fr","url":"https:\/\/fchevalier.net\/blog\/informatique\/terragrunt-terraform-dry\/","author":{"@type":"Person","name":"Fabien CHEVALIER"},"copyrightYear":"2025","dateCreated":"2025-04-16T00:00:00\u002b00:00","datePublished":"2025-04-16T00:00:00\u002b00:00","dateModified":"2025-04-16T00:00:00\u002b00:00","keywords":["cloud","terraform","iac","terragrunt","dry"],"mainEntityOfPage":"true","wordCount":"3618"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://fchevalier.net/","name":"Home","position":1},{"@type":"ListItem","item":"https://fchevalier.net/blog/","name":"Blog","position":2},{"@type":"ListItem","item":"https://fchevalier.net/categories/iac/","name":"Iac","position":3},{"@type":"ListItem","name":"Terragrunt Et Découverte De L' Iac en Mode Dry","position":4}]}</script><meta name=author content="Fabien CHEVALIER"><link href=mailto:contact@fchevalier.net rel=me><link href=https://github.com/fabienchevalier rel=me><link href=https://linkedin.com/in/fabche rel=me><link href=https://soundcloud.com/user-351918779 rel=me><script defer type=text/javascript src=/js/mermaid.bundle.832624a553672a6ccda17159509c1ec6d0d691d57d975bab3ea0c67d4b5f45e838af68b83e8b06f78aa79c286b60388f54be6e274806fdbdc642a0019161d9e2.js integrity="sha512-gyYkpVNnKmzNoXFZUJwextDWkdV9l1urPqDGfUtfReg4r2i4PosG94qnnChrYDiPVL5uJ0gG/b3GQqABkWHZ4g=="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-0MZTJRMB11"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0MZTJRMB11")}</script></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>Aller au contenu</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a href=/ class=mr-2><img src=/img/logo.png width=48 height=48 class="max-h-[10rem] max-w-[10rem] object-scale-down object-left" alt>
</a><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/></a></div><ul class="flex list-none flex-col text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/projets/ title=Projets><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">📌 projets</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/blog/ title=Blog><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">📖 blog</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=https://fchevalier.net/cv title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">📋 cv</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title="Rechercher (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Terragrunt et découverte de l'IAC en mode DRY</h1><div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2025-04-16 00:00:00 +0000 UTC">16 avril 2025</time><span class="px-2 text-primary-500">&#183;</span><span title="Temps de lecture">17 mins</span></div></div><div class=prose><picture class="mb-6 rounded-md"><source srcset="/blog/informatique/terragrunt-terraform-dry/cover_hu_e676cb3d15e6ab46.webp 330w,/blog/informatique/terragrunt-terraform-dry/cover_hu_dba8efdddcb0a7fd.webp 660w
,/blog/informatique/terragrunt-terraform-dry/cover_hu_fb17cdbd0ae360a5.webp 1024w
,/blog/informatique/terragrunt-terraform-dry/cover_hu_f5ea2e3174b9575.webp 1320w" sizes=100vw type=image/webp><img width=1920 height=1080 class="mb-6 rounded-md" src=/blog/informatique/terragrunt-terraform-dry/cover_hu_a138a3c804a34f0e.png srcset="/blog/informatique/terragrunt-terraform-dry/cover_hu_6bbc6dec5fbc2b22.png 330w,/blog/informatique/terragrunt-terraform-dry/cover_hu_a138a3c804a34f0e.png 660w
,/blog/informatique/terragrunt-terraform-dry/cover_hu_c576e2760549c64c.png 1024w
,/blog/informatique/terragrunt-terraform-dry/cover_hu_22fd95830d26c896.png 1320w" sizes=100vw></picture></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 lg:sticky lg:top-10 print:hidden"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Sommaire</summary><div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#contexte>Contexte</a></li><li><a href=#cest-quoi-concrètement-terragrunt>C&rsquo;est quoi concrètement, Terragrunt</a></li><li><a href=#lorganisation-du-code>L&rsquo;organisation du code</a><ul><li><a href=#contexte-client>Contexte client</a></li><li><a href=#schéma-darchitecture>Schéma d&rsquo;architecture</a></li><li><a href=#hiérarchie-des-dossiers>Hiérarchie des dossiers</a><ul><li><a href=#le-repo-marketplace-infrastructure>Le repo <code>marketplace-infrastructure</code></a></li><li><a href=#le-repo-infrastructure-shared-modules>Le repo <code>infrastructure-shared-modules</code></a></li></ul></li><li><a href=#fichiers-de-configurations-terragrunt>Fichiers de configurations Terragrunt</a><ul><li><a href=#fonctions-terragrunt>Fonctions Terragrunt</a></li><li><a href=#configuration-des-locals>Configuration des <code>locals</code></a></li><li><a href=#gestion-du-backend-terraform>Gestion du <code>backend</code> Terraform</a></li></ul></li><li><a href=#configuration-dun-layer>Configuration d&rsquo;un <code>layer</code></a><ul><li><a href=#gestion-des-modules-terraform-de-façon-dry>Gestion des modules Terraform de façon DRY</a></li><li><a href=#que-se-passe-t-il-lorsque-je-lance-un-terragrunt-apply->Que se passe-t-il lorsque je lance un <code>terragrunt apply</code> ?</a></li><li><a href=#le-concept-de-terragrunt-run-all>Le concept de `terragrunt run-all</a></li></ul></li></ul></li><li><a href=#last-but-not-least--la-gestion-des-dépendances>Last but not least : la gestion des dépendances</a></li><li><a href=#pour-conclure>Pour conclure</a><ul><li><a href=#procons>Pro/Cons</a></li><li><a href=#bootstrap-ton-projet>Bootstrap ton projet</a></li></ul></li><li><a href=#sources>Sources</a></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><span class=flex><span class="ms-1 rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Nouvel article!</span></span><div class="lead !mb-9 text-xl">Terragrunt est un wrapper (surcouche) pour Terraform, conçu pour simplifier et optimiser la gestion des configurations d&rsquo;infrastructure en suivant le principe DRY (Don&rsquo;t Repeat Yourself). Dans cet article, je vais tenter d&rsquo;expliquer le fonctionnement de Terragrunt à travers un cas client fictif.</div><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>Depuis la création du clone <code>open-source</code> de Terraform, à savoir <a href=https://opentofu.org/ target=_blank rel=noreferrer>OpenTofu</a>, Terragrunt utilisera par défaut <code>OpenTofu</code> si il est installé sur ta machine. Dans cet article, je me base sur Terraform mais la logique reste la même.</span></div><blockquote><p>Cet article s’appuie sur des exemples fictifs et des conventions publiques, largement documentés dans la communauté. Il ne doit pas être considéré comme un guide exhaustif, mais plutôt comme une introduction à l&rsquo;utilisation de Terragrunt dans un contexte professionnel.</p></blockquote><h2 id=introduction class="relative group">Introduction <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#introduction aria-label=Ancre>#</a></span></h2><p>Reprenant les bonnes pratiques issues du monde du développement, Terragrunt permet de réduire la duplication de code en factorisant les configurations Terraform. Cet article à pour but d&rsquo;expliquer la mise en place d&rsquo;un projet Terraform avec Terragrunt, et surtout de comprendre là où Terragrunt apporte de la valeur par rapport à Terraform seul. Attention, Terragrunt nécessite des bases <strong>solides</strong> en configurations Terraform, cet article se destine donc à un public ayant déjà pratiqué Terraform sur des infrastructures moyennes à grandes, et souhaitant en optimiser la gestion afin de passer à l&rsquo;échelle. Si ce n&rsquo;est pas ton cas, je t&rsquo;invite à consulter <a href=https://blog.stephane-robert.info/docs/infra-as-code/provisionnement/terraform/introduction/ target=_blank rel=noreferrer>cette section</a> du blog de Stéphane Robert pour te familiariser avec Terraform. Tout y est très bien expliqué.</p><h2 id=contexte class="relative group">Contexte <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#contexte aria-label=Ancre>#</a></span></h2><p>J&rsquo;ai été amené à travailler pour un client ayant une infrastructure cloud conséquente, et logiquement beaucoup de ressources à gérer. La principale problématique rencontrée dans la gestion d&rsquo;une architecture de cette taille avec Terraform est pour moi l&rsquo;organisation même du code, et la dette technique qui en découle. En effet, à force de multiplier les ressources, variables, environnements etc.. , on peut vite se retrouver avec du code difficile à comprendre et maintenir, surtout lors de phases de build avec des deadlines serrées.</p><p>Terragrunt se veut être une réponse efficace à ces problématiques en apportant une organisation <strong>claire</strong> et <strong>modulaire</strong> au code Terraform. En externalisant les paramètres spécifiques à chaque environnement et en automatisant la gestion des dépendances entre modules, Terragrunt offre une solution structurée pour minimiser la dette technique.</p><p><figure><picture class="mx-auto my-0 rounded-md"><source srcset=/blog/informatique/terragrunt-terraform-dry/imgs/illustrations1-terraform_hu_1068fe5b521c8c6a.webp sizes=100vw type=image/webp><img width=616 height=353 class="mx-auto my-0 rounded-md" alt=plan-b-jeu loading=lazy decoding=async src=/blog/informatique/terragrunt-terraform-dry/imgs/illustrations1-terraform.jpg></picture><figcaption class=text-center>Illustration de circonstance : Plan B est un jeu proposant de &mldr; Terraformer une planète. Cool, non ?</figcaption></figure></p><p>Cependant, son adoption n&rsquo;est pas forcément pertinente pour des projets de petite taille, et peut même être contre-productive si mal utilisée <em>(👋 <a href=https://www.appvia.io/blog/5-reasons-you-should-not-use-kubernetes target=_blank rel=noreferrer>Kubernetes</a>)</em>. De plus, la courbe d&rsquo;apprentissage peut être assez raide, j&rsquo;en ai fais les frais.</p><p>Comprendre les concepts de modularité, d’héritage de configurations ou encore de gestion des dépendances demande un investissement initial non négligeable. Cela dit, une fois compris et bien utilisé, Terragrunt peut vite se révéler indispensable. Il permet de structurer efficacement des projets complexes, et de réduire la duplication de code (factorisation) de manière élégante.</p><p>Dans cet article, je vais donc tenter de t&rsquo;expliquer une manière d&rsquo;utiliser Terragrunt, à travers un exemple fictif. Je pense qu&rsquo;il est plus facile d&rsquo;intégrer certains concepts appliqués à une situation concrète, plutôt que de se plonger dans la théorie. Après tout, la <a href=https://terragrunt.gruntwork.io/docs/getting-started/quick-start/ target=_blank rel=noreferrer>doc officielle</a> est (très) bien écrite 🙃.</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Je présente ici une méthode d&rsquo;utilisation de Terragrunt, et non <strong>LA</strong> méthode. A tes risques et périls 😎.</span></div><p>Les exemples que je vais fournir se basent sur des configurations GCP, mais la logique est applicable à n&rsquo;importe quel cloud provider. Il ne s&rsquo;agira pas ici d&rsquo;expliquer comment bootstrap tel ou tel ressources, mais plutôt de te montrer comment organiser ton code Terraform avec Terragrunt.</p><h2 id=cest-quoi-concrètement-terragrunt class="relative group">C&rsquo;est quoi concrètement, Terragrunt <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cest-quoi-concr%c3%a8tement-terragrunt aria-label=Ancre>#</a></span></h2><p><figure><picture class="mx-auto my-0 rounded-md"><source srcset="/blog/informatique/terragrunt-terraform-dry/imgs/key-features-terraform-code-dry_hu_29e4cc75f4654a55.webp 330w,/blog/informatique/terragrunt-terraform-dry/imgs/key-features-terraform-code-dry_hu_22a5e83905dfbe3b.webp 660w
,/blog/informatique/terragrunt-terraform-dry/imgs/key-features-terraform-code-dry_hu_8a36347f913254de.webp 1024w
,/blog/informatique/terragrunt-terraform-dry/imgs/key-features-terraform-code-dry_hu_5ebe01bf9ec201cf.webp 1320w" sizes=100vw type=image/webp><img width=1598 height=708 class="mx-auto my-0 rounded-md" alt=schema-terragrunt loading=lazy decoding=async src=/blog/informatique/terragrunt-terraform-dry/imgs/key-features-terraform-code-dry_hu_dc2590ca57a5f7b.png srcset="/blog/informatique/terragrunt-terraform-dry/imgs/key-features-terraform-code-dry_hu_7a3fce1dfc4172a9.png 330w,/blog/informatique/terragrunt-terraform-dry/imgs/key-features-terraform-code-dry_hu_dc2590ca57a5f7b.png 660w
,/blog/informatique/terragrunt-terraform-dry/imgs/key-features-terraform-code-dry_hu_5fb083d308a3b1d2.png 1024w
,/blog/informatique/terragrunt-terraform-dry/imgs/key-features-terraform-code-dry_hu_3d0f194a85662fbd.png 1320w" sizes=100vw></picture><figcaption class=text-center>Schéma représentatif d&rsquo;une configuration Terragrunt, issu du site de Terragrunt</figcaption></figure></p><p>Terragrunt est avant-tout un outil <code>CLI</code>, reprenant la syntaxe de Terraform dans son fonctionnement ad-hoc. On retrouvera donc les fameux <code>terragrunt plan</code>, <code>terragrunt apply</code>, etc.. Là où ça devient intéressant, c&rsquo;est que Terragrunt propose en sus des fonctionnalités comme la génération dynamiques de fichiers <code>backend.tf</code> (oui, il permet aussi de créer le <code>bucket</code> à la volée si celui-ci n&rsquo;existe pas), des <a href=https://terragrunt.gruntwork.io/docs/reference/built-in-functions/ target=_blank rel=noreferrer>fonctions</a> permettant de manipuler des fichiers <code>HCL</code> (comme <code>read_terragrunt_config</code>), ou encore une gestion avancée des dépendances entre modules.</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Je te recommande de lire au moins le début <a href=https://terragrunt.gruntwork.io/docs/getting-started/quick-start/ target=_blank rel=noreferrer>du quickstart Terragrunt</a> présent dans la documentation officielle. Cela t&rsquo;aideras grandement à comprendre les concepts détaillés par la suite dans cet article.</span></div><h2 id=lorganisation-du-code class="relative group">L&rsquo;organisation du code <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#lorganisation-du-code aria-label=Ancre>#</a></span></h2><p>L&rsquo;organisation du code, ainsi que l&rsquo;architecture des dossiers sont <strong>extrêmement</strong> importante. Encore une fois, l&rsquo;usage de Terragrunt permet de forcer des bonnes pratiques, mais un mauvais choix d&rsquo;organisation peut vite se révéler cauchemardesque, en particulier avec Terragrunt. Pour cet article, je vais donc choisir de baser mes explications sur le cas d&rsquo;un client fictif, mais qui se rapproche de ce que j&rsquo;ai pu voir dans le monde réel.</p><h3 id=contexte-client class="relative group">Contexte client <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#contexte-client aria-label=Ancre>#</a></span></h3><p>Partons du principe suivant : je souhaite héberger pour le compte d&rsquo;un client une application <a href=https://fr.wikipedia.org/wiki/Architecture_trois_tiers target=_blank rel=noreferrer>3 tiers</a> classique, afin d&rsquo;héberger une marketplace. Niveau ressources cloud, on aura donc besoin de :</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Je travaille beaucoup sur GCP en ce moment, pour simplifier la rédaction de mon article, je me base donc sur des assets GCP.</span></div><ul><li>Configurer un réseau VPC (subneting, firewall rules, etc..).</li><li>Mettre en place une base de données</li><li>Déployer une application web (front + back), dans mon exemple containérisée</li><li>Mettre en place un load balancer et un orchestrateur de conteneurs, par facilitée je vais ici utiliser CloudRun.</li></ul><p>On parle d&rsquo;IaC, il va donc falloir créer et organiser son code via des repos Git. Les développeurs vont travailler sur leurs repos respectifs, à savoir <code>marketplace-frontend</code> et <code>marketplace-backend</code>. En parallèle, il va falloir créer un repo appelé <code>marketplace-infrastructure</code> permettant de définir l&rsquo;infrastructure permettant d&rsquo;héberger l&rsquo;application (base de données, load balancer, etc..). Enfin, un repo <code>infrastructure-shared-modules</code> sera créé afin de gérer et versionner nos modules. Je ne vais pas m&rsquo;attarder sur les questions de CI/CD et autres, ce n&rsquo;est pas le sujet ici.</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>Je ne fournirais pas le code des modules, ni même la configuration complète de l&rsquo;infrastructure. Je me limite ici uniquement à l&rsquo;abstraction Terragrunt. J&rsquo;ai cependant rédigé un article détaillant la mise en place complète d&rsquo;une infrastructure via Terraform disponible <a href=https://fchevalier.net/projets/projet_etude_master/ target=_blank rel=noreferrer>ici</a>.</span></div><h3 id=schéma-darchitecture class="relative group">Schéma d&rsquo;architecture <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#sch%c3%a9ma-darchitecture aria-label=Ancre>#</a></span></h3><p>Pour contextualiser un peu tout ça, voici un schéma d&rsquo;architecture basique représentant les briques à déployer :</p><p><figure><img src=./imgs/scheme.png alt=scheme class="mx-auto my-0 rounded-md"><figcaption class=text-center>Schéma de l&rsquo;architecture de l&rsquo;application</figcaption></figure></p><p>D&rsquo;un premier abord, dans le cas où mon client fictif ne souhaite utiliser que deux environnements de développement, pour ce projet unique, Terragrunt serais overkill. Imaginons maintenant que ce même client souhaite 4 environnements, à savoir <code>dev</code>, <code>staging</code>, <code>preprod</code> et <code>prod</code>. De plus, il viens de recevoir une demande du métier, nécessitant la mise en place de 6 applications similaires. Tu vois ou je veux en venir ?</p><h3 id=hiérarchie-des-dossiers class="relative group">Hiérarchie des dossiers <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#hi%c3%a9rarchie-des-dossiers aria-label=Ancre>#</a></span></h3><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>La logique d&rsquo;organisation des dossiers est directement inspirée de l&rsquo;excellent <a href=https://github.com/padok-team/docs-terraform-guidelines/blob/main/terragrunt/context_pattern.md target=_blank rel=noreferrer>repo maintenu par Padok</a>, fournissant des bonnes pratiques sur l&rsquo;utilisation de Terraform, et notamment le concept de <code>layers</code>. Je t&rsquo;invites à le consulter.</span></div><p>Je sais donc que je dois livrer la marketplace en premier lieu, sur 4 environnements, mais avec en tête le fait que quelques semaines plus tard la demande évoluera. Là, on rentre dans un cas ou Terragrunt pourra m&rsquo;être utile, car je vais pouvoir <strong>factoriser</strong> dès le début.</p><p>Pour illustrer mon explication, je vais me concentrer sur deux briques de l&rsquo;architecture, à savoir le <code>load balancer</code> et le <code>cloud run</code>. Bien sûr, il faudra configurer bien plus de ressources afin de rendre mon architecture fonctionnelle, mais <strong>je cherche ici à expliquer la logique de factorisation induite par Terragrunt</strong>.</p><h4 id=le-repo-marketplace-infrastructure class="relative group">Le repo <code>marketplace-infrastructure</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#le-repo-marketplace-infrastructure aria-label=Ancre>#</a></span></h4><p>Voici l&rsquo;architecture de dossier proposée :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>└── layers
</span></span><span class=line><span class=cl>    ├── cloud-run
</span></span><span class=line><span class=cl>    │   ├── marketplace-frontend  
</span></span><span class=line><span class=cl>    |   |   ├── dev  
</span></span><span class=line><span class=cl>    |   |   ├── staging  
</span></span><span class=line><span class=cl>    |   |   ├── preprod  
</span></span><span class=line><span class=cl>    |   |   └── prod  
</span></span><span class=line><span class=cl>    |   |── marketplace-backend  
</span></span><span class=line><span class=cl>    |        ├── dev  
</span></span><span class=line><span class=cl>    |        ├── staging  
</span></span><span class=line><span class=cl>    |        ├── preprod  
</span></span><span class=line><span class=cl>    |        └── prod  
</span></span><span class=line><span class=cl>    └── load-balancer
</span></span><span class=line><span class=cl>        ├── dev
</span></span><span class=line><span class=cl>        ├── staging
</span></span><span class=line><span class=cl>        ├── preprod
</span></span><span class=line><span class=cl>        └── prod
</span></span><span class=line><span class=cl>etc etc...
</span></span></code></pre></div><p>Ma ressource <code>cloud-run</code> permettra de déployer les deux services de mon application, à savoir le <code>frontend</code> et le <code>backend</code>. Je vais donc créer un dossier <code>cloud-run</code>, contenant deux sous-dossiers, un pour chaque service. Chaque service contiendra les environnements de développement, staging, preprod et prod.</p><p>Le dossier <code>load-balancer</code> contiendra lui aussi les environnements de développement, staging, preprod et prod.</p><h4 id=le-repo-infrastructure-shared-modules class="relative group">Le repo <code>infrastructure-shared-modules</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#le-repo-infrastructure-shared-modules aria-label=Ancre>#</a></span></h4><p>Le mot-clé factorisation reviens souvent dans cet article. On a parlé plus haut d&rsquo;un futur besoin pour mon client d&rsquo;ajouter de nouvelles applications. Au lieu d&rsquo;avoir à réécrire (ou copier/coller) le code de chaque module, lors de la création d&rsquo;une nouvelle application, autant tout rassembler au même endroit dans un repo séparé. Je le hiérarchise de cette manière :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>└── modules
</span></span><span class=line><span class=cl>    ├── cloud-run
</span></span><span class=line><span class=cl>    ├── load-balancer
</span></span><span class=line><span class=cl>    ├── vpc
</span></span><span class=line><span class=cl>etc etc...
</span></span></code></pre></div><p>Ok, nous avons à présent nos deux repo, ainsi qu&rsquo;une architecture de dossier claire et facile à comprendre. Passons aux fichiers de configuration.</p><h3 id=fichiers-de-configurations-terragrunt class="relative group">Fichiers de configurations Terragrunt <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#fichiers-de-configurations-terragrunt aria-label=Ancre>#</a></span></h3><p>Au sein du dossier <code>layers</code>, dans le repo <code>marketplace-infrastructure</code> à la racine, je vais créer un fichier <code>root.hcl</code> (<a href=https://github.com/padok-team/docs-terraform-guidelines/blob/main/terragrunt/context_pattern.md target=_blank rel=noreferrer>le fichier de configuration Terragrunt <code>racine</code></a>).</p><p>Terragrunt fonctionne de manière récursive. Si tu appliques la configuration Terragrunt du dossier <code>layers/load-balancer/dev/terragrunt.hcl</code>, il va remonter dans l&rsquo;arborescence jusqu&rsquo;à trouver le fichier <code>root.hcl</code> et l&rsquo;injecter dans la configuration. Le nommage est ici est complètement arbitraire, mais sache que Terragrunt à besoin d&rsquo;au moins un fichier appelé <code>terragrunt.hcl</code> à la racine de chacune de tes stacks.</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Le concept de <code>stack</code> dans Terragrunt représente une unité de déploiement. Chaque <code>stack</code> correspond à un environnement spécifique (par exemple, dev, staging, prod) et peut contenir plusieurs modules ou ressources. En d&rsquo;autres termes, une <code>stack</code> est une collection de ressources Terraform qui sont gérées ensemble.</span></div><h4 id=fonctions-terragrunt class="relative group">Fonctions Terragrunt <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#fonctions-terragrunt aria-label=Ancre>#</a></span></h4><p>Terragrunt propose un certain nombre de fonctions permettant de manipuler les fichiers de configuration, de la même manière que les fonctions natives Terraform. J&rsquo;en utilise quelques unes dans cet article. Sans aller dans le détail, Terragrunt propose des fonctions supplémentaires, plus globales permettant de récupérer du contexte de façon dynamique. Des exemples sont donnés et expliqués dans les sections suivantes. Tu peux retrouver l&rsquo;ensemble de ces fonctions documentées ici : <a href=https://terragrunt.gruntwork.io/docs/reference/built-in-functions/ target=_blank rel=noreferrer>Terragrunt Built-in Functions</a>.</p><h4 id=configuration-des-locals class="relative group">Configuration des <code>locals</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#configuration-des-locals aria-label=Ancre>#</a></span></h4><p>Dans <code>root.hcl</code>, on va définir définir des <a href=https://developer.hashicorp.com/terraform/language/values/locals target=_blank rel=noreferrer>locals</a>, c&rsquo;est à dire des expressions communes à l&rsquo;ensemble de mes environnements dans un contexte Terraform. On y retrouvera donc l&rsquo;<code>id</code> du projet, la region, et autres. Voici un exemple :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># root.hcl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>locals</span> {
</span></span><span class=line><span class=cl><span class=n>  env_name</span>     <span class=o>=</span> <span class=k>basename</span><span class=p>(</span><span class=k>get_original_terragrunt_dir</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>  region</span>       <span class=o>=</span> <span class=s2>&#34;europe-west2&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  env_config</span>   <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span><span class=k>local</span><span class=p>.</span><span class=k>env_settings</span><span class=p>,</span> <span class=k>local</span><span class=p>.</span><span class=k>env_config</span><span class=p>,</span> {}<span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>  env_settings</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    dev</span> <span class=o>=</span> {                            
</span></span><span class=line><span class=cl>      <span class=n>project_id</span> <span class=o>=</span> <span class=s2>&#34;marketplace-dev&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      vpc</span>        <span class=o>=</span> <span class=s2>&#34;marketplace&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      labels</span>     <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        environment</span> <span class=o>=</span> <span class=s2>&#34;dev&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        application</span> <span class=o>=</span> <span class=s2>&#34;marketplace&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        managed_by</span>  <span class=o>=</span> <span class=s2>&#34;terraform&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }<span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>    staging</span> <span class=o>=</span> {                            
</span></span><span class=line><span class=cl>      <span class=n>project_id</span> <span class=o>=</span> <span class=s2>&#34;marketplace-staging&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      vpc</span>        <span class=o>=</span> <span class=s2>&#34;marketplace&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      labels</span>     <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        environment</span> <span class=o>=</span> <span class=s2>&#34;staging&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        application</span> <span class=o>=</span> <span class=s2>&#34;marketplace&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        managed_by</span>  <span class=o>=</span> <span class=s2>&#34;terraform&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }<span class=p>,</span>     
</span></span><span class=line><span class=cl>    <span class=n>preprod</span> <span class=o>=</span> {                            
</span></span><span class=line><span class=cl>      <span class=n>project_id</span> <span class=o>=</span> <span class=s2>&#34;marketplace-preprod&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      vpc</span>        <span class=o>=</span> <span class=s2>&#34;marketplace&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      labels</span>     <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        environment</span> <span class=o>=</span> <span class=s2>&#34;preprod&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        application</span> <span class=o>=</span> <span class=s2>&#34;marketplace&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        managed_by</span>  <span class=o>=</span> <span class=s2>&#34;terraform&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }<span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> {                            
</span></span><span class=line><span class=cl>      <span class=n>project_id</span> <span class=o>=</span> <span class=s2>&#34;marketplace-prod&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      vpc</span>        <span class=o>=</span> <span class=s2>&#34;marketplace&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      labels</span>     <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        environment</span> <span class=o>=</span> <span class=s2>&#34;prod&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        application</span> <span class=o>=</span> <span class=s2>&#34;marketplace&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        managed_by</span>  <span class=o>=</span> <span class=s2>&#34;terraform&#34;</span>
</span></span><span class=line><span class=cl>      }      
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> {}
</span></span></code></pre></div><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Dans le cas ou l&rsquo;on souhaite utiliser un Cloud Provider different, comme <code>AWS</code> par exemple, il faudra adapter la configuration des <code>locals</code> en fonction de la logique de nommage de ton provider. Par exemple, pour AWS, il faudra adapter le <code>region</code> et le <code>project_id</code> en fonction de la logique de nommage AWS (<code>account_id</code> par exemple au lieu du <code>project_id</code>).</span></div><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>Ce fichier de configuration part du principe qu&rsquo;un réseau VPC a déjà été créé par projet. Ici, dans chaque environnement, on connectera les <code>assets</code> au réseau <code>marketplace</code>.</span></div><p>Détaillons un peu ce fichier :</p><ul><li><p><code>env_name</code>: ici, la fonction <code>basename()</code> permet d&rsquo;extraire le dernier segment d&rsquo;un chemin donné. Utilisée de pair avec <code>get_original_terragrunt_dir()</code>, elle permet d&rsquo;obtenir le nom de l&rsquo;environnement actuel (par exemple, dev, staging, etc.) en se basant sur le chemin du répertoire où se situe <code>terragrunt.hcl</code>, toujours de manière <strong>absolue</strong>.</p></li><li><p><code>region</code>: très simple, ici la région est <code>hardcodée</code> car ne changera pas.</p></li><li><p><code>env_config</code> : utilise <code>lookup()</code> (fonction Terraform) pour récupérer la configuration de l’environnement actuel. Si l’environnement n’existe pas dans <code>env_settings</code>, la valeur par défaut <code>{}</code> est utilisée pour éviter les erreurs.</p></li><li><p><code>env_settings</code>: ce bloc définit une <code>map</code> contenant les configurations spécifiques à chaque environnement (par exemple, dev, staging, etc.). Ici, on l&rsquo;utilise pour spécifier de manière globale le <code>project_id</code> et le <code>vpc</code> pour chaque environnement (dans l&rsquo;exemple donné). On pourrait y ajouter d&rsquo;autres configurations que l&rsquo;on souhaite centraliser tel que des <code>tags</code> etc.</p></li></ul><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Les fonctions <code>lookup()</code> et <code>basename()</code> sont des fonctions natives de Terraform. Terragrunt n&rsquo;étant qu&rsquo;une surcouche de Terraform, il est possible d&rsquo;utiliser ces fonctions dans les fichiers de configuration Terragrunt.</span></div><p>Au final, malgré la complexité apparente, ce fichier <code>root.hcl</code> ne fais que fournir des variables génériques de façon dynamique.</p><h4 id=gestion-du-backend-terraform class="relative group">Gestion du <code>backend</code> Terraform <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#gestion-du-backend-terraform aria-label=Ancre>#</a></span></h4><p>A la suite de la déclaration des <code>locals</code>, on va pouvoir définir la configuration du <code>backend</code> Terraform. En effet, Terragrunt permet de gérer le <code>backend</code> de manière centralisée, et de le générer automatiquement dans chaque <code>layer</code>. Voici un exemple de configuration :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>remote_state</span> {
</span></span><span class=line><span class=cl><span class=n>  backend</span> <span class=o>=</span> <span class=s2>&#34;gcs&#34;</span><span class=c1> # Google Cloud Storage, mais peut être S3, etc.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  config</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    encrypt</span>  <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>    bucket</span>   <span class=o>=</span> <span class=s2>&#34;${local.project_id}-tfstates&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    project</span>  <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>    prefix</span>   <span class=o>=</span> <span class=s2>&#34;tfstate/${path_relative_to_include()}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    location</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>region</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl><span class=n>  generate</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    path</span>      <span class=o>=</span> <span class=s2>&#34;backend.tf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    if_exists</span> <span class=o>=</span> <span class=s2>&#34;skip&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>On va donc se retrouver avec un fichier <code>state</code> par environnement, et par module. Par exemple, pour le module <code>cloud-run</code>, on va se retrouver avec un fichier <code>tfstate</code> dans le bucket <code>marketplace-dev-tfstates</code> (pour l&rsquo;environnement dev), avec le prefix <code>tfstate/cloud-run/marketplace-frontend</code>.</span></div><p>Terragrunt propose aussi de générer le fichier <code>provider.tf</code>, de la même manière que le fichier <code>backend.tf</code>. Dans mon exemple, je préfère gérer la configuration du provider dans chaque module, mais sache cela reste une possibilité.</p><h3 id=configuration-dun-layer class="relative group">Configuration d&rsquo;un <code>layer</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#configuration-dun-layer aria-label=Ancre>#</a></span></h3><p>Pour le moment donc, j&rsquo;ai couvert la configuration <code>racine</code>, permettant de factoriser à la base de l&rsquo;arborescence. Comme dit plus haut, c&rsquo;est de cette manière que Terragrunt permet de construire une infrastructure en mode <code>DRY</code>. Descendons maintenant d&rsquo;un cran dans l&rsquo;arborescence, et voyons comment configurer un asset <code>cloud-run</code> par exemple.</p><h4 id=gestion-des-modules-terraform-de-façon-dry class="relative group">Gestion des modules Terraform de façon DRY <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#gestion-des-modules-terraform-de-fa%c3%a7on-dry aria-label=Ancre>#</a></span></h4><p>Naviguons dans le dossier <code>layers/cloud-run/</code>. Son contenu sera le suivant :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>└── cloud-run
</span></span><span class=line><span class=cl>    ├── dev
</span></span><span class=line><span class=cl>    │   ├── inputs.hcl
</span></span><span class=line><span class=cl>    │   └── terragrunt.hcl
</span></span><span class=line><span class=cl>    ├── module.hcl
</span></span><span class=line><span class=cl>    ├── preprod
</span></span><span class=line><span class=cl>    │   ├── inputs.hcl
</span></span><span class=line><span class=cl>    │   └── terragrunt.hcl
</span></span><span class=line><span class=cl>    ├── prod
</span></span><span class=line><span class=cl>    │   ├── inputs.hcl
</span></span><span class=line><span class=cl>    │   └── terragrunt.hcl
</span></span><span class=line><span class=cl>    └── staging
</span></span><span class=line><span class=cl>        ├── inputs.hcl
</span></span><span class=line><span class=cl>        └── terragrunt.hcl
</span></span></code></pre></div><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Dans l&rsquo;<a href=https://github.com/gruntwork-io/terragrunt-infrastructure-live-example/blob/main/prod/us-east-1/prod/mysql/terragrunt.hcl target=_blank rel=noreferrer>exemple fourni par Gruntwork</a>, tout est centralisé au sein d&rsquo;un fichier unique <code>terragrunt.hcl</code>. En créant un fichier <code>inputs</code>, je me permet de séparer la logique de configuration de la logique d&rsquo;<code>include</code>. C&rsquo;est un choix arbitraire, mais qui me semble plus clair. Même chose pour le fichier <code>module.hcl</code>, qui source le module Terraform.</span></div><p>Commençons par le contenu du fichier <code>module.hcl</code>. Rappelles toi, j&rsquo;ai indiqué en intro qu&rsquo;il était nécessaire de créer un repo <code>infrastructure-shared-modules</code> pour y stocker mes modules. C&rsquo;est ici que je vais les référencer :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># module.hcl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>terraform</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span> <span class=o>=</span><span class=n> &#34;git@github.com:my-org/infrastructure-shared-modules.git//modules/cloudrun?ref</span><span class=o>=</span><span class=k>cloudrun</span><span class=err>-</span><span class=k>v1</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=m>0</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>Ici, je fais un choix. Je pourrais sourcer directement le module dans chaque <code>terragrunt.hcl</code>, afin d&rsquo;être en mesure d&rsquo;avoir un module pour chaque environnement. Cela-dit, dans une logique qui se veut <code>ISO</code>, je préfères que chaque environnements soient identiques à la production.</span></div><p>Concrètement, mon repo <code>infrastructure-shared-modules</code> va contenir l&rsquo;ensemble de mes modules, versionnés via <code>git</code>.</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>Je te conseilles vivement de <code>tag</code> tes modules, afin de pouvoir revenir en arrière si besoin. En effet, si tu fais évoluer un module, et que tu ne tag pas ta version, tu risques d&rsquo;appliquer les changements à l&rsquo;ensemble des configurations.</span></div><p>En backstage, Terragrunt va cloner ce <code>repo</code>, et lui fournir les <code>inputs</code> définies dans chaque fichiers <code>inputs.hcl</code>. On retrouvera d&rsquo;ailleurs un dossier <code>.terragrunt-cache</code>, contenant le repo cloné dans chaque environnement.</p><h4 id=que-se-passe-t-il-lorsque-je-lance-un-terragrunt-apply- class="relative group">Que se passe-t-il lorsque je lance un <code>terragrunt apply</code> ? <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#que-se-passe-t-il-lorsque-je-lance-un-terragrunt-apply- aria-label=Ancre>#</a></span></h4><p>Un petit coup d&rsquo;oeil sur le fichier <code>terragrunt.hcl</code> permet de se rendre compte de toute la logique expliquée précédemment :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>include</span> <span class=s2>&#34;root&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  path</span>           <span class=o>=</span> <span class=k>find_in_parent_folders</span><span class=p>(</span><span class=s2>&#34;root.hcl&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>  merge_strategy</span> <span class=o>=</span> <span class=s2>&#34;deep&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>include</span> <span class=s2>&#34;module&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  path</span>           <span class=o>=</span> <span class=k>find_in_parent_folders</span><span class=p>(</span><span class=s2>&#34;module.hcl&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>  merge_strategy</span> <span class=o>=</span> <span class=s2>&#34;deep&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>include</span> <span class=s2>&#34;inputs&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  path</span>           <span class=o>=</span> <span class=s2>&#34;inputs.hcl&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  merge_strategy</span> <span class=o>=</span> <span class=s2>&#34;deep&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Ce qui se résume schématiquement :</p><div class=mermaid align=center>flowchart TD
A[terragrunt.hcl] --> B[root.hcl]
A --> C[module.hcl]
A --> D[inputs.hcl]</div><p>Terragrunt parcourra depuis le dossier courant, et remontera dans l&rsquo;arborescence jusqu&rsquo;à trouver les fichiers <code>root.hcl</code>; <code>module.hcl</code> et <code>inputs.hcl</code>. Il va ensuite fusionner le contenu de ces fichiers, en appliquant la stratégie de fusion définie dans chaque <code>include</code>. Dans notre cas, on a choisi la stratégie <code>deep</code>, qui va permettre de fusionner les objets imbriqués. La <a href=https://terragrunt.gruntwork.io/docs/reference/config-blocks-and-attributes/#include target=_blank rel=noreferrer>documentation de Terragrunt</a> permettra d&rsquo;en savoir plus sur les différentes stratégies de fusion, et le fonctionnement d&rsquo;include en général.</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Pour faire simple, on peut partir du principe que Terragrunt va fusionner les fichiers de configuration en un seul fichier, en appliquant la stratégie de fusion définie dans chaque <code>include</code>. Il va ensuite appliquer cette configuration au module Terraform. Le fichier <code>input.hcl</code> contiendra donc l&rsquo;équivalent d&rsquo;un fichier <code>variables.tf</code> dans un module Terraform classique. Il va permettre de définir les variables d&rsquo;entrées pour le module, et sera fusionné avec les autres fichiers de configuration.</span></div><h4 id=le-concept-de-terragrunt-run-all class="relative group">Le concept de `terragrunt run-all <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#le-concept-de-terragrunt-run-all aria-label=Ancre>#</a></span></h4><p>Cette commande va permettre d&rsquo;appliquer l&rsquo;ensemble des configurations de manière récursive, en une seule commande. C&rsquo;est bien là que toute la puissance de Terragrunt se révèle.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terragrunt run-all apply layers/
</span></span></code></pre></div><p>En effet, si tu as bien suivi, cette commande permettra en une fois de créer l&rsquo;ensemble des ressources de l&rsquo;application, pour chaque environnement, et d&rsquo;automatiquement générer la configuration <code>backend.tf</code>.</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Pour peu que tu aie les droits sur ton cloud-provider, Terragrunt se charge même de créer le bucket <code>tfstates</code> pour toi, si celui-ci n&rsquo;existe pas. DRY.</span></div><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>Il est préférable, dans un contexte ou des dépendances sont présentes, de passer par <code>run-all</code> afin que Terragrunt puisse correctement mettre à jour l&rsquo;état des ressources. En effet, si tu appliques les configurations une par une, certaines valeurs peuvent être obsolètes (ex. <code>connection_string</code> d&rsquo;une base de données), et donc entraîner des erreurs lors de l&rsquo;application des configurations.</span></div><h2 id=last-but-not-least--la-gestion-des-dépendances class="relative group">Last but not least : la gestion des dépendances <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#last-but-not-least--la-gestion-des-d%c3%a9pendances aria-label=Ancre>#</a></span></h2><p>Tu t&rsquo;es peut être posé la question à le lecture de cet article : si Terragrunt cherche à appliquer une configuration dépendante d&rsquo;une autre, comment fait-il pour savoir dans quel ordre appliquer les ressources ? En effet, si je souhaite créer un <code>cloud-run</code> et lui permettre de se connecter à une base de données, il faut que la base de données soit créée avant le <code>cloud-run</code>. Terragrunt propose une fonctionnalité permettant de gérer les dépendances entre modules, et donc d&rsquo;appliquer les ressources dans le bon ordre.</p><div class="flex rounded-md bg-primary-100 px-4 py-3 dark:bg-primary-900"><span class="pe-3 text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg>
</span></span><span class=dark:text-neutral-300>Attention, Terragrunt reste un <strong>wrapper</strong> Terraform. Pour que le système de dépendances fonctionne, il faut que tes modules Terraform puissent <code>output</code> des valeurs que tu pourras ensuite utiliser dans d&rsquo;autres modules. Par exemple, si tu souhaites créer un <code>cloud-run</code> qui se connecte à une base de données, il faut que le module de la base de données <code>output</code> la <code>connection_string</code> de la base de données, afin que le module <code>cloud-run</code> puisse s&rsquo;y connecter.</span></div><p>Concrètement, cela peut donner quelque chose comme ça pour un <code>cloud-run</code> ayant besoin d&rsquo;exposer une variable d&rsquo;environnement <code>DATABASE_URL</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># cloud-run/inputs.hcl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>dependency</span> <span class=s2>&#34;cloud_sql&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  config_path</span> <span class=o>=</span> <span class=s2>&#34;cloud-sql/${basename(get_original_terragrunt_dir())}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  mock_outputs</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    connection_string</span> <span class=o>=</span> <span class=s2>&#34;postgres://user:password@host:port/dbname&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>locals</span> {<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # On récupère la configuration commune définie dans root.hcl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  common</span> <span class=o>=</span> <span class=k>read_terragrunt_config</span><span class=p>(</span><span class=k>find_in_parent_folders</span><span class=p>(</span><span class=s2>&#34;root.hcl&#34;</span><span class=p>)).</span><span class=k>locals</span>
</span></span><span class=line><span class=cl><span class=n>  config</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common</span><span class=p>.</span><span class=k>config</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>  project_id</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>config</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  region</span>     <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common</span><span class=p>.</span><span class=k>region</span>
</span></span><span class=line><span class=cl><span class=n>  env_name</span>   <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common</span><span class=p>.</span><span class=k>env_name</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>secrets</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    DATABASE_URL</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      value</span> <span class=o>=</span> <span class=k>dependency</span><span class=p>.</span><span class=k>cloud_sql</span><span class=p>.</span><span class=k>outputs</span><span class=p>.</span><span class=k>connection_string</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Attardons nous un peu sur la partie <code>mock_output</code>. C&rsquo;est une des fonctionnalités Terragrunt qui peuvent se révéler intéressantes pour le développement. En effet, si tu souhaites tester ta configuration sans avoir à créer l&rsquo;ensemble des ressources, tu peux utiliser <code>mock_output</code> pour simuler les valeurs de sortie d&rsquo;un module. Cela te permet de <code>plan</code> sans obtenir d&rsquo;erreur lorsque le module n&rsquo;est pas encore créé.</p><h2 id=pour-conclure class="relative group">Pour conclure <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pour-conclure aria-label=Ancre>#</a></span></h2><p>Concrètement, la difficulté se situe vraiment dans la compréhension de la logique de <code>merge</code> de Terragrunt. Pour maintenir une infrastructure <code>DRY</code>, Terragrunt utilise des fonctions et des <code>includes</code> pour fusionner les fichiers de configuration à l&rsquo;<code>apply</code>. Cela nécessite donc (comme souvent lorsqu&rsquo;on automatise) de rendre dynamique la configuration, et de recourir à des fonctions comme <code>get_parent_terragrunt_dir()</code> ou <code>get_original_terragrunt_dir()</code> afin de variabiliser un maximum.</p><h3 id=procons class="relative group">Pro/Cons <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#procons aria-label=Ancre>#</a></span></h3><p>Tu l&rsquo;as bien compris, la mise en place d&rsquo;une architecture <code>DRY</code> avec Terragrunt reste relativement complexe de part l&rsquo;abstraction qu&rsquo;elle propose. Selon moi, la valeur ajoutée vaut le coup si :</p><ul><li>Ton projet possède de nombreux environnements à gérer (dev, staging, prod, etc..).</li><li>Tu dois gérer un grand nombre d&rsquo;applications/infrastructures identiques, mais dont la configuration diffère par environnement (une BDD plus petite en dev&mldr;).</li><li>Tu souhaites gérer des modules Terraform de manière centralisée, et versionnée, et les appliquer à l&rsquo;ensemble de tes environnements.</li></ul><p>Terragrunt devrais être un gros <code>no-go</code> si :</p><ul><li>Ton projet est de petite taille, et que tu n&rsquo;as pas besoin de gérer plus de deux environnements.</li><li>Tu n&rsquo;as pas forcément la bande passante et/ou une équipe qui te permettra de maintenir tes modules.</li><li>Tu n&rsquo;est pas 100% à l&rsquo;aise avec Terraform : pour débugger du Terragrunt il faut être en mesure de réellement comprendre ce qu&rsquo;il applique en arrière plan.</li></ul><p>Cet article décris l&rsquo;organisation et la manière de gérer l&rsquo;infrastructure via les commandes ad-hoc Terragrunt (<code>terragrunt plan/apply</code>) afin d&rsquo;en cerner le fonctionnement. Bien entendu, il est possible d&rsquo;utiliser Terragrunt dans un pipeline CI/CD. Une <a href=https://github.com/gruntwork-io/terragrunt-action target=_blank rel=noreferrer>action managée GitHub</a> et d&rsquo;ailleurs proposée par Gruntwork, l&rsquo;éditeur de Terragrunt.</p><h3 id=bootstrap-ton-projet class="relative group">Bootstrap ton projet <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bootstrap-ton-projet aria-label=Ancre>#</a></span></h3><p>Si tu souhaites un bon point de départ pour démarrer un projet Terragrunt, <a href=https://github.com/gruntwork-io/terragrunt-infrastructure-live-example/tree/main target=_blank rel=noreferrer><span class="icon relative inline-block align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span>clone ce repo</a>, et adapte le selon tes besoins. Tu peux par exemple reprendre la logique de découpage expliquée dans cet article (layers, modules, etc..).</p><p>N&rsquo;hésites pas à me contacter ou de laisser un commentaire si tu souhaites échanger sur le sujet, j&rsquo;ai l&rsquo;impression que Terragrunt commence à avoir le vent en poupe, et je serais ravi d&rsquo;en discuter avec toi.</p><h2 id=sources class="relative group">Sources <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#sources aria-label=Ancre>#</a></span></h2><ul><li><a href=https://terragrunt.gruntwork.io/docs/ target=_blank rel=noreferrer>Terragrunt Documentation</a></li><li><a href=https://developer.hashicorp.com/terraform/docs target=_blank rel=noreferrer>Terraform Documentation</a></li><li><a href=https://github.com/gruntwork-io/terragrunt-infrastructure-live-example/tree/main target=_blank rel=noreferrer>terragrunt-infrastructure-live-example</a></li><li><a href=https://github.com/padok-team/docs-terraform-guidelines/tree/main target=_blank rel=noreferrer>docs-terraform-guidelines</a></li><li><a href=https://cloud.theodo.com/en/blog/terraform-code-terragrunt target=_blank rel=noreferrer>Reduce redundancy in your Terraform code with Terragrunt</a></li></ul></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><picture class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"><img width=301 height=301 class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full" alt="Fabien CHEVALIER" loading=lazy decoding=async src=/img/author.png></picture><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Auteur</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Fabien CHEVALIER</div><div class="text-sm text-neutral-700 dark:text-neutral-400">DevOps ☁️ @claranet-france - 💻 Computer geek and open-source lover</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=mailto:contact@fchevalier.net target=_blank aria-label=Email rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/fabienchevalier target=_blank aria-label=Github rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://linkedin.com/in/fabche target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://soundcloud.com/user-351918779 target=_blank aria-label=Soundcloud rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 640 512"><path fill="currentcolor" d="M111.4 256.3l5.8 65-5.8 68.3c-.3 2.5-2.2 4.4-4.4 4.4s-4.2-1.9-4.2-4.4l-5.6-68.3 5.6-65c0-2.2 1.9-4.2 4.2-4.2 2.2.0 4.1 2 4.4 4.2zm21.4-45.6c-2.8.0-4.7 2.2-5 5l-5 105.6 5 68.3c.3 2.8 2.2 5 5 5 2.5.0 4.7-2.2 4.7-5l5.8-68.3-5.8-105.6c0-2.8-2.2-5-4.7-5zm25.5-24.1c-3.1.0-5.3 2.2-5.6 5.3l-4.4 130 4.4 67.8c.3 3.1 2.5 5.3 5.6 5.3 2.8.0 5.3-2.2 5.3-5.3l5.3-67.8-5.3-130c0-3.1-2.5-5.3-5.3-5.3zM7.2 283.2c-1.4.0-2.2 1.1-2.5 2.5L0 321.3l4.7 35c.3 1.4 1.1 2.5 2.5 2.5s2.2-1.1 2.5-2.5l5.6-35-5.6-35.6c-.3-1.4-1.1-2.5-2.5-2.5zm23.6-21.9c-1.4.0-2.5 1.1-2.5 2.5l-6.4 57.5 6.4 56.1c0 1.7 1.1 2.8 2.5 2.8s2.5-1.1 2.8-2.5l7.2-56.4-7.2-57.5c-.3-1.4-1.4-2.5-2.8-2.5zm25.3-11.4c-1.7.0-3.1 1.4-3.3 3.3L47 321.3l5.8 65.8c.3 1.7 1.7 3.1 3.3 3.1 1.7.0 3.1-1.4 3.1-3.1l6.9-65.8-6.9-68.1c0-1.9-1.4-3.3-3.1-3.3zm25.3-2.2c-1.9.0-3.6 1.4-3.6 3.6l-5.8 70 5.8 67.8c0 2.2 1.7 3.6 3.6 3.6s3.6-1.4 3.9-3.6l6.4-67.8-6.4-70c-.3-2.2-2-3.6-3.9-3.6zm241.4-110.9c-1.1-.8-2.8-1.4-4.2-1.4-2.2.0-4.2.8-5.6 1.9-1.9 1.7-3.1 4.2-3.3 6.7v.8l-3.3 176.7 1.7 32.5 1.7 31.7c.3 4.7 4.2 8.6 8.9 8.6s8.6-3.9 8.6-8.6l3.9-64.2-3.9-177.5c-.4-3-2-5.8-4.5-7.2zm-26.7 15.3c-1.4-.8-2.8-1.4-4.4-1.4s-3.1.6-4.4 1.4c-2.2 1.4-3.6 3.9-3.6 6.7l-.3 1.7-2.8 160.8s0 .3 3.1 65.6v.3c0 1.7.6 3.3 1.7 4.7 1.7 1.9 3.9 3.1 6.4 3.1 2.2.0 4.2-1.1 5.6-2.5 1.7-1.4 2.5-3.3 2.5-5.6l.3-6.7 3.1-58.6-3.3-162.8c-.3-2.8-1.7-5.3-3.9-6.7zm-111.4 22.5c-3.1.0-5.8 2.8-5.8 6.1l-4.4 140.6 4.4 67.2c.3 3.3 2.8 5.8 5.8 5.8 3.3.0 5.8-2.5 6.1-5.8l5-67.2-5-140.6c-.2-3.3-2.7-6.1-6.1-6.1zm376.7 62.8c-10.8.0-21.1 2.2-30.6 6.1-6.4-70.8-65.8-126.4-138.3-126.4-17.8.0-35 3.3-50.3 9.4-6.1 2.2-7.8 4.4-7.8 9.2v249.7c0 5 3.9 8.6 8.6 9.2h218.3c43.3.0 78.6-35 78.6-78.3.1-43.6-35.2-78.9-78.5-78.9zm-296.7-60.3c-4.2.0-7.5 3.3-7.8 7.8l-3.3 136.7 3.3 65.6c.3 4.2 3.6 7.5 7.8 7.5s7.5-3.3 7.5-7.5l3.9-65.6-3.9-136.7c-.3-4.5-3.3-7.8-7.5-7.8zm-53.6-7.8c-3.3.0-6.4 3.1-6.4 6.7l-3.9 145.3 3.9 66.9c.3 3.6 3.1 6.4 6.4 6.4 3.6.0 6.4-2.8 6.7-6.4l4.4-66.9-4.4-145.3c-.3-3.6-3.1-6.7-6.7-6.7zm26.7 3.4c-3.9.0-6.9 3.1-6.9 6.9L227 321.3l3.9 66.4c.3 3.9 3.1 6.9 6.9 6.9s6.9-3.1 6.9-6.9l4.2-66.4-4.2-141.7c0-3.9-3-6.9-6.9-6.9z"/></svg></span></a></div></div></div></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/&amp;quote=Terragrunt%20et%20d%c3%a9couverte%20de%20l%27IAC%20en%20mode%20DRY" title="Poster sur Facebook" aria-label="Poster sur Facebook" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/&amp;text=Terragrunt%20et%20d%c3%a9couverte%20de%20l%27IAC%20en%20mode%20DRY" title=Tweeter aria-label=Tweeter target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://tootpick.org/#text=https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/%20Terragrunt%20et%20d%c3%a9couverte%20de%20l%27IAC%20en%20mode%20DRY" title aria-label target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://pinterest.com/pin/create/bookmarklet/?url=https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/&amp;description=Terragrunt%20et%20d%c3%a9couverte%20de%20l%27IAC%20en%20mode%20DRY" title="Poster sur Pinterest" aria-label="Poster sur Pinterest" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M496 256c0 137-111 248-248 248-25.6.0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8.0 128.7-68.8 128.7-154.3.0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1.0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6.0-54.7 41.4-107.6 112-107.6 60.9.0 103.6 41.5 103.6 100.9.0 67.1-33.9 113.6-78 113.6-24.3.0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6.0-19-10.2-34.9-31.4-34.9-24.9.0-44.9 25.7-44.9 60.2.0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9.0 361.1.0 256 0 119 111 8 248 8s248 111 248 248z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/&amp;resubmit=true&amp;title=Terragrunt%20et%20d%c3%a9couverte%20de%20l%27IAC%20en%20mode%20DRY" title="Poster sur Reddit" aria-label="Poster sur Reddit" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/&amp;title=Terragrunt%20et%20d%c3%a9couverte%20de%20l%27IAC%20en%20mode%20DRY" title="Poster sur LinkedIn" aria-label="Poster sur LinkedIn" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a class="m-1 inline-block min-w-[2.4rem] rounded bg-neutral-300 p-1 text-center text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://fchevalier.net/blog/informatique/terragrunt-terraform-dry/&amp;subject=Terragrunt%20et%20d%c3%a9couverte%20de%20l%27IAC%20en%20mode%20DRY" title="Envoyer par email" aria-label="Envoyer par email" target=_blank rel="noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/blog/informatique/aws-ec2-cloudgaming-instance/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Provisionner sa propre instance de jeu Windows Server dans le cloud AWS via CloudFormation</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-03-30 00:00:00 +0000 UTC">30 mars 2023</time>
</span></span></a></span><span></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://fchevalier.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></footer></article></main><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12" id=to-top hidden=true><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Faire défiler jusqu'au bas de la page" title="Faire défiler jusqu'au bas de la page">&uarr;</a></div><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="group mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a href=/categories/ title=Categories><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Catégories</span></a></li><li class="group mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a href=/tags/ title=Tags><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li><li class="group mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a href title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">À propos</span></a></li></ul></nav><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Fabien CHEVALIER</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Propulsé par <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"><div class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher-0 type=button aria-label="appearance switcher"><div class="flex h-12 w-12 items-center justify-center dark:hidden" title="Passer au thème sombre"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden h-12 w-12 items-center justify-center dark:flex" title="Passer au thème clair"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div></div><script type=text/javascript src="https://cdn.jsdelivr.net/npm/cookie-bar/cookiebar-latest.min.js?tracking=1&thirdparty=1&always=1&showNoConsent=1"></script></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://fchevalier.net/><div id=search-modal class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex flex-none items-center justify-between px-2"><form class="flex min-w-0 flex-auto items-center"><div class="flex h-8 w-8 items-center justify-center text-neutral-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Rechercher tabindex=0></form><button id=close-search-button class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Fermer (Esc)">
<span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto overflow-auto px-2"><ul id=search-results></ul></section></div></div></div></body></html>